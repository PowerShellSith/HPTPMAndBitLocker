{"name":"HPTPMAndBitLocker","tagline":"Custom Powershell Module to ease TPM and BitLocker Administration for HP Workstations","body":"###*THIS MODULE HAS THE ABILITY TO MODIFY BIOS SETTINGS USE AT YOUR OWN RISK*###\r\n\r\n**Highly customized BitLocker PowerShell Module for TPM Administration and BitLocker Administration for HP Workstations.**\r\n\r\nI have found the \"MangeBde.exe\" CLI tool a little cumbersome, so I am developing a \"More Powerful\" BitLocker  PowerShell Module.\r\nAlso, the BiosConfigurationUtility from HP is even more cumbersome to manage TPM, with the verbiage being slightly different between models, I need model specific configuration files for every pc I manage to activate and enable TPM.\r\n\r\nThis Modules contains the following Functions:\r\n* Get-HPBiosSetupPasswordIsSet\r\n* Test-HPBiosSetupPassword\r\n* Test-HPTPMEnabledAndActivated \r\n* Invoke-HPTPM\r\n* Get-BitLockerStatus\r\n* Invoke-BitLockerWithTPMAndNumricalKeyProtectors\r\n* Get-UnEncryptedWorkstationsFromCMDB\r\n\r\nThe first two functions are more for internal use of the module, the three HP tailored functions are *-HP* are tailored specifically for HP BIOS and TPM administration, essentially replacing the BiosConfigurationUtility usage TPM.  The remaining functions can be used on any workstation.\r\n```PowerShell\r\n# Configure TPM on HP Models:\r\nImport-Module .\\HPTpmAndBitLocker.psm1\r\n# Current Setup Password, if there is not a current password, one will randomly be generated, and removed after configuration completes.\r\n# A Setup Password is required for pragmatically modifying the BIOS.\r\n$password = \"\"\r\n\r\nif (-not (Test-HPTPMEnabledAndActivated))\r\n{\r\n\tif(-not(Test-HPBiosSetupPasswordIsSet))\r\n\t{\r\n\t\t$password = powershell \". .\\Scripts\\New-RandomPassword.ps1; New-RandomPassword -Length 14 -Lowercase -Uppercase -Numbers\"\r\n\t\t$randomPasswordUsed = $true\r\n\t\tSet-HPBiosSetupPassword -NewPassword $password\r\n\t}\r\n\r\n\tInvoke-HPTPM -Password $password\r\n\r\n\tif ($randomPasswordUsed)\r\n\t{\r\n\t\tSet-HPBiosSetupPassword -NewPassword \" \" -CurrentPassword $password\r\n\t}\r\n}\r\n```\r\n\t\r\nI have included a function in this module that will get unencrypted PCs from a SCCM database so you can foreach the value on the systems and enforce BDE.\r\n```PowerShell\r\nImport-Module HPTPMAndBitLocker\r\n[String[]]$unEncryptedWorkStations = (Get-UnEncryptedWorkstationsFromCMDB -SqlServer SCCM_DB_Server -Database CM_ABC -IntergratedSecurity).ComputerName\r\n\r\nforeach ($workstation in $unEncryptedWorkStations)\r\n{\r\n\t# do things to Enforce BitLocker....\r\n}\r\n```\r\n\t\r\n**UPDATE**\r\n\r\nI have added a second script in the .\\Scripts Directory called Enforce-Bde.ps1 that has a full enforcement and logging, just sent the params for your Logs Directory and for your ConfigMgr SQL Server.  You need to enable BitLockerDrive status in your ConfigMgr Client Settings to use this Script.\r\n```PowerShell\r\n# Globals\r\n\r\n$SqlServer = [String]::Empty\r\n$CCMDatabase = [String]::Empty\r\n\r\nif ([String]::IsNullOrEmpty($SqlServer) -or [String]::IsNullOrEmpty($CCMDatabase))\r\n{\r\n\tthrow \"You must provide the CCM SqlServerName and Database to use this script\"\r\n\texit\r\n}\r\n\r\n# End Globals\r\n\r\n# Functions\r\n\r\n<#\r\n.SYNOPSIS\r\n\tLogs Events to a a logfile.\r\n.DESCRIPTION\r\n\tLogs all errors foreach operation to a file.\r\n.INPUT\r\n    System.String\r\n.OUTPUT\r\n    None.\r\n.EXAMPLE\r\n\tWrite-LogEntry -Path C:\\My.log -Event \"MyEvent: Event\"\r\n#>\r\nFunction Write-LogEntry\r\n{\r\n\t[CmdletBinding()]\r\n\t[OutputType([Void])]\r\n\tParam\r\n\t(\r\n\t\t# Path, Type string, File path to the log.\r\n\t\t[Parameter(Mandatory = $true)]\r\n\t\t[String]\r\n\t\t$Path,\r\n\r\n\t\t# Event, Type string, Event entry to append to the log.\r\n\t\t[parameter(Mandatory = $true,\r\n\t\t\t\t\tValueFromPipeLineByPropertyName = $true)]\r\n\t\t[String[]]\r\n\t\t$Event\r\n\t)\r\n\r\n\tAdd-Content $Path -Value ((Get-Date).ToLongDateString()+\" \"+(Get-Date).ToLongTimeString()+\": \"+$Event)\r\n}\r\n\r\n# End Functions\r\n\r\n# Main\r\n\r\nImport-Module HPTPMAndBitLocker\r\n$password = PowerShell \". .\\New-RandomPassword.ps1; New-RandomPassword -Length 14 -Lowercase -Uppercase -Numbers\"\r\n$log = \".\\Logs\\$(Get-Date -Format yyyyMMdd)_Enforce-BDE.ps1.log\"\r\n[String[]]$unEncryptedWorkStations = (Get-UnEncryptedWorkstationsFromCCMDB -SqlServer $SqlServer -Database $CCMDatabase -IntergratedSecurity).ComputerName\r\n\r\nWrite-LogEntry -Path $log -Event \"####################################\"\r\nWrite-LogEntry -Path $log -Event \"##### START OF ENFORCEMENT RUN #####\"\r\nWrite-LogEntry -Path $log -Event \"####################################\"\r\nWrite-LogEntry -Path $log -Event (\"Total Number of Unencrypted Workstations: $($unEncryptedWorkStations.Length)\")\r\n\r\nforeach ($computer in $unEncryptedWorkStations)\r\n{\r\n\tWrite-LogEntry -Path $log -Event \"Attempting to ping $computer...\"\r\n\r\n\tif (-not (Test-Connection $computer -Count 1 -ErrorAction SilentlyContinue))\r\n\t{\r\n\t\tWrite-LogEntry -Path $log -Event $Error[0].ToString()\r\n\t}\r\n\telse\r\n\t{\r\n\t\tWrite-LogEntry -Path $log -Event \"Successfully contacted $computer.\"\r\n\t\t\t\r\n\t\tWrite-LogEntry -Path $log -Event \"Testing for TrueCrypt Disk Encryption on $computer...\"\r\n\t\tif (Test-Path \"$env:ProgramData\\TrueCrypt\\Original System Loader\")\r\n\t\t{\r\n\t\t\t$SMSCli = [WmiClass]\"\\\\$computer\\root\\ccm:SMS_Client\"\r\n\t\t\t$SMSCli.TriggerSchedule(\"{00000000-0000-0000-0000-000000000002}\") | Out-Null\r\n\t\t\tWrite-LogEntry -Path $log -Event \"Computer is fully encrypted with TrueCrypt Full Disk Encryption, triggering ccm software inventory cycle for $computer...\"\r\n\t\t\tbreak\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tWrite-LogEntry -Path $log -Event \"TrueCrypt Disk Encryption not detected on $computer...\"\r\n\t\t}\r\n\t\tWrite-LogEntry -Path $log -Event \"Retrieving TPM status for $computer...\"\r\n\t\ttry\r\n\t\t{\r\n            Write-LogEntry -Path $log -Event (\"TPM Properly Configured: $(Test-HPTPMEnabledAndActivated -ComputerName $computer)\") \r\n\t\t}\r\n\t\tcatch\r\n\t\t{\r\n\t\t\tWrite-LogEntry -Path $log -Event $error[0].ToString()\r\n\t\t\tContinue\r\n\t\t}\r\n\r\n\t\tif (-not (Test-HPTPMEnabledAndActivated -ComputerName $computer))\r\n\t\t{\r\n\t\t\tWrite-LogEntry -Path $log -Event \"TPM is not properly configured on $computer.\"\r\n\t\t\tWrite-LogEntry -Path $log -Event \"Retrieving setup password state on $computer...\"\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\tif (-not(Test-HPBiosSetupPasswordIsSet -ComputerName $computer))\r\n\t\t\t\t{\r\n\t\t\t\t\tWrite-LogEntry -Path $log -Event \"Setup password is set: False\"\r\n\t\t\t\t\tWrite-LogEntry -Path $log -Event (\"Generating password: \" + ($password = powershell \". .\\Scripts\\New-RandomPassword.ps1; New-RandomPassword -Length 14 -Lowercase -Uppercase -Numbers\"))\r\n\t\t\t\t\tSet-HPBiosSetupPassword -ComputerName $computer -NewPassword $password | %{ Write-LogEntry -Path $log -Event $_ }\r\n\t\t\t\t}\r\n\t\t\t\tWrite-LogEntry -Path $log -Event \"Setup password is set: True\"\r\n\t\t\t\tInvoke-HPTPM -ComputerName $computer -Password $password | %{ Write-LogEntry -Path $log -Event $_ }\r\n\t\t\t\tWrite-LogEntry -Path $log -Event \"Removing Setup password from $computer...\"\r\n\t\t\t\tSet-HPBiosSetupPassword -ComputerName $computer -NewPassword \" \" -CurrentPassword $password | %{ Write-LogEntry -Path $log -Event $_ }\r\n\t\t\t\tWrite-LogEntry -Path $log -Event \"System reboot required to complete TPM configuration.  BitLocker will be enforced on next run after reboot.\"\r\n\t\t\t}\r\n\t\t\tcatch\r\n\t\t\t{\r\n\t\t\t\tWrite-LogEntry -Path $log -Event $error[0].ToString()\r\n\t\t\t\tContinue\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tWrite-LogEntry -Path $log -Event \"TPM is properly configured on $computer.\"\r\n\t\t\tWrite-LogEntry -Path $log -Event \"Retrieving BitLocker status on $computer...\"\r\n\t\t\tWrite-LogEntry -Path $log -Event (\"Protection: $((Get-BitLockerStatus -ComputerName $computer).Protection)\")\r\n\t\t\tWrite-LogEntry -Path $log -Event (\"State: $((Get-BitLockerStatus -ComputerName $computer).State)\")\r\n\t\t\tWrite-LogEntry -Path $log -Event (\"Percentage: $((Get-BitLockerStatus -ComputerName $computer).Percentage)\")\r\n\t\t\tif ((Get-BitLockerStatus -ComputerName $computer).Protection -eq \"ProtectionOn\")\r\n\t\t\t{\r\n\t\t\t\t$SMSCli = [WmiClass]\"\\\\$computer\\root\\ccm:SMS_Client\"\r\n\t\t\t\t$SMSCli.TriggerSchedule(\"{00000000-0000-0000-0000-000000000001}\") | Out-Null\r\n\t\t\t\tWrite-LogEntry -Path $log -Event \"Computer is fully encrypted and protection is on, triggering ccm hardware inventory cycle for $computer...\"\r\n\t\t\t}\r\n\t\t\telseif ((Get-BitLockerStatus -ComputerName $computer).State -ne \"EncryptionInProgress\")\r\n\t\t\t{\r\n\t\t\t\tWrite-LogEntry -Path $log -Event \"Invoking BitLocker drive encryption on $computer.\"\r\n\t\t\t\r\n\t\t\t\tInvoke-BitLockerWithTPMAndNumricalKeyProtectors -ComputerName $computer -ADKeyBackup | Out-Null\r\n\r\n\t\t\t\tWrite-LogEntry -Path $log -Event (\"Protection: $((Get-BitLockerStatus -ComputerName $computer).Protection)\")\r\n\t\t\t\tWrite-LogEntry -Path $log -Event (\"State: $((Get-BitLockerStatus -ComputerName $computer).State)\")\r\n\t\t\t\tWrite-LogEntry -Path $log -Event (\"Percentage: $((Get-BitLockerStatus -ComputerName $computer).Percentage)\")\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nWrite-LogEntry -Path $log -Event \"##################################\"\r\nWrite-LogEntry -Path $log -Event \"##### END OF ENFORCEMENT RUN #####\"\r\nWrite-LogEntry -Path $log -Event \"##################################\"\r\n\r\n# End Main\r\n```","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}